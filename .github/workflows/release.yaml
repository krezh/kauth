name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]' | head -n 2 | tail -n 1)
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          VERSION=${CURRENT_TAG#v}

          # Generate changelog (handle first release case)
          if [ -n "$PREV_TAG" ]; then
            echo "## Changes since ${PREV_TAG}" > changelog.md
            echo "" >> changelog.md
            git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%an)" --no-merges >> changelog.md
          else
            echo "## Initial Release" > changelog.md
            echo "" >> changelog.md
            echo "First release of kauth!" >> changelog.md
            echo "" >> changelog.md
            echo "## All Changes" >> changelog.md
            echo "" >> changelog.md
            git log ${CURRENT_TAG} --pretty=format:"- %s (%an)" --no-merges >> changelog.md
          fi

          echo "" >> changelog.md
          echo "" >> changelog.md
          echo "## Container Images" >> changelog.md
          echo "" >> changelog.md
          echo '```bash' >> changelog.md
          echo "docker pull ghcr.io/${{ github.repository }}-server:${CURRENT_TAG}" >> changelog.md
          echo "docker pull ghcr.io/${{ github.repository }}-server:${VERSION}" >> changelog.md
          echo "docker pull ghcr.io/${{ github.repository }}-server:latest" >> changelog.md
          echo '```' >> changelog.md

          cat changelog.md

      - name: Install Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4
        with:
          version: latest

      - name: Log in to Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version
        id: version
        run: |
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          VERSION=${CURRENT_TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$CURRENT_TAG" >> $GITHUB_OUTPUT

      - name: Update Helm Chart version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Update Chart.yaml with correct version
          sed -i "s/^version:.*/version: $VERSION/" helm/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"$VERSION\"/" helm/Chart.yaml

      - name: Package Helm Chart
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          helm package helm

      - name: Push Helm Chart to GHCR
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          helm push kauth-server-${VERSION}.tgz oci://ghcr.io/${{ github.repository_owner }}/charts
          echo "Helm chart pushed to oci://ghcr.io/${{ github.repository_owner }}/charts/kauth-server:${VERSION}"

      - name: Update changelog with Helm chart info
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"

          echo "" >> changelog.md
          echo "## Helm Chart" >> changelog.md
          echo "" >> changelog.md
          echo '```bash' >> changelog.md
          echo "helm install kauth-server oci://ghcr.io/${{ github.repository_owner }}/charts/kauth-server --version ${VERSION}" >> changelog.md
          echo '```' >> changelog.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090 # v2
        with:
          body_path: changelog.md
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
